<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="updateInvoices">

    <!--

    select

    line_of_business,
    invoice_no
    mother_invoice_ref

     -->
    <sql id="selectTrxInvoice-fragment">
    select
    coalesce (inv.id ,nextval('kv_invoices_id')) as id,
    stage.id as load_id,
    58 as tenant_id,
    0 as import_id,
    stage.account_id,
    0 as dpd,
    0 as mpd,
    0 as status_id,
    current_timestamp as created_at,
    current_timestamp as updated_at,
    '0' as created_by,
    '0' as updated_by,
    0 as invoice_status_id,
    0 as invoice_outstanding_with_interest,
    0 as gst,
    0 as import_status_id,
    0 as branch_id,
    false as in_aging,
    0 as flag_id,
    current_timestamp as last_listener_run,
    null as recon_acct,
    'MY' as currency,
    null as tax_code,
    0 as kv_amount,
    0 as kv_amount_dc,
</sql>

    <sql id="insertTrxInvoice-fragment">
    insert into kv_invoices as invoices (
    id,load_id,tenant_id,import_id,account_id,dpd,mpd,status_id,created_at,updated_at,created_by,updated_by,invoice_status_id,
    invoice_outstanding_with_interest,gst,import_status_id,branch_id,in_aging,flag_id,last_listener_run,recon_acct,
    currency,tax_code,kv_amount,kv_amount_dc,line_of_business,invoice_no,invoice_reference)
    </sql>

    <sql id="updateTrxInvoice-fragment">

    on conflict (load_id) do update
    set
    id = excluded.id,
    load_id = excluded.load_id,
    tenant_id = excluded.tenant_id,
    import_id = excluded.import_id,
    account_id = excluded.account_id,
    dpd = excluded.dpd,
    mpd = excluded.mpd,
    status_id = excluded.status_id,
    created_at = excluded.created_at,
    updated_at = excluded.updated_at,
    created_by = excluded.created_by,
    updated_by = excluded.updated_by,
    invoice_status_id = excluded.invoice_status_id,
    invoice_outstanding_with_interest = excluded.invoice_outstanding_with_interest,
    gst = excluded.gst,
    import_status_id = excluded.import_status_id,
    branch_id = excluded.branch_id,
    in_aging = excluded.in_aging,
    flag_id = excluded.flag_id,
    last_listener_run = excluded.last_listener_run,
    recon_acct = excluded.recon_acct,
    currency = excluded.currency,
    tax_code = excluded.tax_code,
    kv_amount = excluded.kv_amount,
    kv_amount_dc = excluded.kv_amount_dc,
    line_of_business = excluded.line_of_business,
    invoice_no = excluded.invoice_no,
    invoice_reference = excluded.invoice_reference
    WHERE invoices.load_id = excluded.load_id
</sql>


    <update id="updateTransactionInvoiceAB">

        <!-- mother_invoice_ref is invoice_reference -->
        <!-- transaction_no is document_no -->
        <include refid="insertTrxInvoice-fragment"/>
        <include refid="selectTrxInvoice-fragment"/>
        case
        when stage.doc_type = 'AB' and stage.is_invoice = true then 'INVOICE'
        when stage.doc_type = 'AB' and (stage.is_invoice = false and stage.is_credit_note = true) then 'CREDIT'
        when stage.doc_type = 'AB' and (stage.is_invoice = false and stage.is_credit_note = false) then 'OTHERS'
        END AS line_of_business,

        case
        when stage.doc_type = 'AB' and stage.is_invoice = true then stage.bill_doc end as invoice_no,

        case
        when stage.doc_type = 'AB' and (stage.is_invoice = false and stage.is_credit_note = true) then
        stage.parent_invoice_no
        when stage.doc_type = 'AB' and (stage.is_invoice = false and stage.is_credit_note = false) then stage.reference
        end as invoice_reference

        from transaction_load stage
        left join kv_invoices inv on stage.id = inv.load_id
        where stage.doc_type = 'AB'

        <include refid="updateTrxInvoice-fragment"/>
    </update>

    <update id="updateTransactionInvoiceRG">

        <!-- mother_invoice_ref is invoice_reference -->
        <include refid="insertTrxInvoice-fragment"/>
        <include refid="selectTrxInvoice-fragment"/>
        CASE
        WHEN DOC_TYPE = 'RG' THEN
        'INVOICE' ELSE '' END AS LINE_OF_BUSINESS,
        CASE
        WHEN DOC_TYPE = 'RG' THEN
        stage.document_no END AS INVOICE_NO

        <include refid="updateTrxInvoice-fragment"/>
    </update>

    <update id="updateTransactionInvoiceYY">
        <include refid="insertTrxInvoice-fragment"/>
        <include refid="selectTrxInvoice-fragment"/>
        CASE
        WHEN DOC_TYPE ='YY' AND transaction_type_id = 1 THEN
        'INVOICE'
        WHEN DOC_TYPE = 'YY'AND transaction_type_id != 1 THEN
        'PAYMENT' ELSE NULL END AS LINE_OF_BUSINESS,
        CASE
        WHEN DOC_TYPE ='YY' AND transaction_type_id = 1 THEN
        stage.document_no ELSE null end as invoice_no,
        CASE
        WHEN DOC_TYPE = 'YY'AND transaction_type_id != 1 THEN
        stage.parent_invoice_no ELSE null END AS invoice_reference

        <include refid="updateTrxInvoice-fragment"/>
    </update>

    <update id="updateTransactionInvoiceGI">
        <include refid="insertTrxInvoice-fragment"/>
        <include refid="selectTrxInvoice-fragment"/>
        CASE
        WHEN DOC_TYPE = 'GI' AND transaction_type_id = 1 THEN
        'INVOICE'
        WHEN DOC_TYPE = 'GI' AND transaction_type_id != 1 THEN
        'PAYMENT' ELSE NULL END AS LINE_OF_BUSINESS,
        CASE
        WHEN DOC_TYPE = 'GI' AND transaction_type_id = 1 THEN
        stage.bill_doc ELSE null end as invoice_no,
        CASE
        WHEN DOC_TYPE = 'GI' AND transaction_type_id != 1 THEN
        stage.parent_invoice_no ELSE null END AS invoice_reference

        <include refid="updateTrxInvoice-fragment"/>
    </update>

    <update id="updateTransactionInvoiceRI">
        <include refid="insertTrxInvoice-fragment"/>
        <include refid="selectTrxInvoice-fragment"/>
        CASE
        WHEN DOC_TYPE = 'RI' AND transaction_type_id = 1 THEN
        'LPC'
        WHEN DOC_TYPE = 'RI' AND transaction_type_id != 1 THEN
        'PAYMENT' ELSE NULL END AS LINE_OF_BUSINESS,
        CASE
        WHEN DOC_TYPE = 'RI' AND transaction_type_id = 1 THEN
        stage.document_no ELSE null end as invoice_no,
        CASE
        WHEN DOC_TYPE = 'RI' AND transaction_type_id != 1 THEN
        stage.parent_invoice_no ELSE null END AS invoice_reference

        <include refid="updateTrxInvoice-fragment"/>
    </update>

    <update id="updateTransactionInvoiceRM">
        <include refid="insertTrxInvoice-fragment"/>
        <include refid="selectTrxInvoice-fragment"/>
        CASE
        WHEN DOC_TYPE = 'RM' THEN
        'DEBIT' ELSE '' END AS LINE_OF_BUSINESS,
        CASE
        WHEN DOC_TYPE = 'RM' THEN
        stage.bill_doc END AS INVOICE_NO,
        CASE
        WHEN stage.doc_type = 'RM' THEN null
        END AS invoice_reference

        <include refid="updateTrxInvoice-fragment"/>
    </update>

    <update id="updateTransactionInvoiceRV">
        <include refid="insertTrxInvoice-fragment"/>
        <include refid="selectTrxInvoice-fragment"/>
        CASE
        WHEN doc_type = 'RV' AND (stage.assignment = stage.bill_doc) THEN
        'INVOICE'
        WHEN doc_type = 'RV' AND (stage.assignment != stage.bill_doc) AND transaction_type_id = 1 THEN
        'DEBIT'
        WHEN doc_type = 'RV' and (stage.assignment != stage.bill_doc)
        AND transaction_type_id != 1 THEN
        'CREDIT'END AS line_of_business,
        CASE
        WHEN doc_type = 'RV' AND
        (stage.assignment != stage.bill_doc) THEN stage.assignment END AS invoice_reference


        <include refid="updateTrxInvoice-fragment"/>
    </update>

    <update id="updateTransactionInvoiceRY">
        <include refid="insertTrxInvoice-fragment"/>
        <include refid="selectTrxInvoice-fragment"/>
        CASE
        WHEN DOC_TYPE = 'RY' THEN
        'INVOICE' ELSE '' END AS LINE_OF_BUSINESS,
        CASE
        WHEN DOC_TYPE = 'RY' THEN
        stage.bill_doc END AS INVOICE_NO,
        CASE
        WHEN stage.doc_type = 'RY' THEN null
        END AS invoice_reference

        <include refid="updateTrxInvoice-fragment"/>
    </update>

    <update id="updateTransactionInvoiceYC">
        <include refid="insertTrxInvoice-fragment"/>
        <include refid="selectTrxInvoice-fragment"/>
        CASE
        WHEN DOC_TYPE = 'YC' THEN
        'INVOICE' ELSE '' END AS LINE_OF_BUSINESS,
        CASE
        WHEN DOC_TYPE = 'YC' THEN
        stage.document_no END AS INVOICE_NO,
        CASE
        WHEN stage.doc_type = 'YC' THEN null
        END AS invoice_reference

        <include refid="updateTrxInvoice-fragment"/>
    </update>

    <update id="updateTransactionInvoiceYD">
        <include refid="insertTrxInvoice-fragment"/>
        <include refid="selectTrxInvoice-fragment"/>
        CASE
        WHEN DOC_TYPE = 'YD' THEN
        'INVOICE' ELSE '' END AS LINE_OF_BUSINESS,
        CASE
        WHEN DOC_TYPE = 'YD' THEN
        stage.bill_doc END AS INVOICE_NO,
        CASE
        WHEN stage.doc_type = 'YD' THEN null
        END AS invoice_reference

        <include refid="updateTrxInvoice-fragment"/>
    </update>

    <update id="updateTransactionInvoiceYH">
        <include refid="insertTrxInvoice-fragment"/>
        <include refid="selectTrxInvoice-fragment"/>
        CASE
        WHEN DOC_TYPE = 'YH' THEN
        'INVOICE' ELSE '' END AS LINE_OF_BUSINESS,
        CASE
        WHEN DOC_TYPE = 'YH' THEN
        stage.bill_doc END AS INVOICE_NO,
        CASE
        WHEN stage.doc_type = 'YH' THEN null
        END AS invoice_reference

        <include refid="updateTrxInvoice-fragment"/>
    </update>

    <update id="updateTransactionInvoiceYI">
        <include refid="insertTrxInvoice-fragment"/>
        <include refid="selectTrxInvoice-fragment"/>
        CASE
        WHEN DOC_TYPE = 'YI' THEN
        'INVOICE' ELSE '' END AS LINE_OF_BUSINESS,
        CASE
        WHEN DOC_TYPE = 'YI' THEN
        stage.document_no END AS INVOICE_NO,
        CASE
        WHEN stage.doc_type = 'YI' THEN null
        END AS invoice_reference

        <include refid="updateTrxInvoice-fragment"/>
    </update>

    <update id="updateTransactionInvoiceYJ">
        <include refid="insertTrxInvoice-fragment"/>
        <include refid="selectTrxInvoice-fragment"/>
        CASE
        WHEN DOC_TYPE = 'YJ' THEN
        'INVOICE' ELSE '' END AS LINE_OF_BUSINESS,
        CASE
        WHEN DOC_TYPE = 'YJ' THEN
        stage.document_no END AS INVOICE_NO,
        CASE
        WHEN stage.doc_type = 'YJ' THEN null
        END AS invoice_reference

        <include refid="updateTrxInvoice-fragment"/>
    </update>

    <update id="updateTransactionInvoiceYL">
        <include refid="insertTrxInvoice-fragment"/>
        <include refid="selectTrxInvoice-fragment"/>
        CASE
        WHEN DOC_TYPE = 'YL' THEN
        'INVOICE' ELSE '' END AS LINE_OF_BUSINESS,
        CASE
        WHEN DOC_TYPE = 'YL' THEN
        stage.bill_doc END AS INVOICE_NO,
        CASE
        WHEN stage.doc_type = 'YL' THEN null
        END AS invoice_reference

        <include refid="updateTrxInvoice-fragment"/>
    </update>

    <update id="updateTransactionInvoiceYN">
        <include refid="insertTrxInvoice-fragment"/>
        <include refid="selectTrxInvoice-fragment"/>
        CASE
        WHEN DOC_TYPE = 'YN' THEN
        'INVOICE' ELSE '' END AS LINE_OF_BUSINESS,
        CASE
        WHEN DOC_TYPE = 'YN' THEN
        stage.document_no END AS INVOICE_NO,
        CASE
        WHEN stage.doc_type = 'YN' THEN null
        END AS invoice_reference

        <include refid="updateTrxInvoice-fragment"/>
    </update>

    <update id="updateTransactionInvoiceYO">
        <include refid="insertTrxInvoice-fragment"/>
        <include refid="selectTrxInvoice-fragment"/>
        CASE
        WHEN DOC_TYPE = 'YO' THEN
        'INVOICE' ELSE '' END AS LINE_OF_BUSINESS,
        CASE
        WHEN DOC_TYPE = 'YO' THEN
        stage.bill_doc END AS INVOICE_NO,
        CASE
        WHEN stage.doc_type = 'YO' THEN null
        END AS invoice_reference

        <include refid="updateTrxInvoice-fragment"/>
    </update>

    <update id="updateTransactionInvoiceYP">
        <include refid="insertTrxInvoice-fragment"/>
        <include refid="selectTrxInvoice-fragment"/>
        CASE
        WHEN DOC_TYPE = 'YP' THEN
        stage.document_no END AS INVOICE_NO,
        CASE
        WHEN stage.doc_type = 'YP' THEN null
        END AS invoice_reference

        <include refid="updateTrxInvoice-fragment"/>
    </update>

    <update id="updateTransactionInvoiceYQ">
        <include refid="insertTrxInvoice-fragment"/>
        <include refid="selectTrxInvoice-fragment"/>
        CASE
        WHEN DOC_TYPE = 'YQ' THEN
        'INVOICE' ELSE '' END AS LINE_OF_BUSINESS,
        CASE
        WHEN DOC_TYPE = 'YQ' THEN
        stage.bill_doc END AS INVOICE_NO,
        CASE
        WHEN stage.doc_type = 'YQ' THEN null
        END AS invoice_reference

        <include refid="updateTrxInvoice-fragment"/>
    </update>

    <update id="updateTransactionInvoiceYR">
        <include refid="insertTrxInvoice-fragment"/>
        <include refid="selectTrxInvoice-fragment"/>
        CASE
        WHEN DOC_TYPE = 'YR' THEN
        'INVOICE' ELSE '' END AS LINE_OF_BUSINESS,
        CASE
        WHEN DOC_TYPE = 'YR' THEN
        stage.bill_doc END AS INVOICE_NO,
        CASE
        WHEN stage.doc_type = 'YR' THEN null
        END AS invoice_reference

        <include refid="updateTrxInvoice-fragment"/>
    </update>

    <update id="updateTransactionInvoiceYS">
        <include refid="insertTrxInvoice-fragment"/>
        <include refid="selectTrxInvoice-fragment"/>
        CASE
        WHEN DOC_TYPE = 'YS' THEN
        'INVOICE' ELSE '' END AS LINE_OF_BUSINESS,
        CASE
        WHEN DOC_TYPE = 'YS' THEN
        stage.bill_doc END AS INVOICE_NO,
        CASE
        WHEN stage.doc_type = 'YS' THEN null
        END AS invoice_reference

        <include refid="updateTrxInvoice-fragment"/>
    </update>

    <update id="updateTransactionInvoiceYT">
        <include refid="insertTrxInvoice-fragment"/>
        <include refid="selectTrxInvoice-fragment"/>
        CASE
        WHEN DOC_TYPE = 'YT' THEN
        'INVOICE' ELSE '' END AS LINE_OF_BUSINESS,
        CASE
        WHEN DOC_TYPE = 'YT' THEN
        stage.bill_doc END AS INVOICE_NO,
        CASE
        WHEN stage.doc_type = 'YT' THEN null
        END AS invoice_reference

        <include refid="updateTrxInvoice-fragment"/>
    </update>

    <update id="updateTransactionInvoiceYU">
        <include refid="insertTrxInvoice-fragment"/>
        <include refid="selectTrxInvoice-fragment"/>
        CASE
        WHEN DOC_TYPE = 'YU' THEN
        'INVOICE' ELSE '' END AS LINE_OF_BUSINESS,
        CASE
        WHEN DOC_TYPE = 'YU' THEN
        stage.bill_doc END AS INVOICE_NO,
        CASE
        WHEN stage.doc_type = 'YU' THEN null
        END AS invoice_reference

        <include refid="updateTrxInvoice-fragment"/>
    </update>


    <update id="updateTransactionInvoiceYV">
        <include refid="insertTrxInvoice-fragment"/>
        <include refid="selectTrxInvoice-fragment"/>
        CASE
        WHEN stage.doc_type = 'YV' THEN 'INVOICE'
        END AS line_of_business,
        CASE
        WHEN stage.doc_type = 'YV' THEN stage.bill_doc
        END AS invoice_no,
        CASE
        WHEN stage.doc_type = 'YV' THEN null
        END AS invoice_reference

        <include refid="updateTrxInvoice-fragment"/>
    </update>

    <update id="updateTransactionInvoiceYW">

        <include refid="insertTrxInvoice-fragment"/>
        <include refid="selectTrxInvoice-fragment"/>
        CASE
        WHEN stage.oc_type = 'YW' THEN 'INVOICE'
        END AS line_of_business,
        CASE
        WHEN stage.doc_type = 'YW' THEN stage.document_no
        END AS invoice_no,
        CASE
        WHEN stage.doc_type = 'YW' THEN null
        END AS invoice_reference

        <include refid="updateTrxInvoice-fragment"/>
    </update>

    <update id="updateTransactionInvoiceYX">

        <include refid="insertTrxInvoice-fragment"/>
        <include refid="selectTrxInvoice-fragment"/>
        CASE
        WHEN stage.doc_type = 'YX' THEN 'INVOICE'
        END AS line_of_business,
        CASE
        WHEN stage.doc_type = 'YX' THEN stage.bill_doc
        END AS invoice_no,
        CASE
        WHEN stage.doc_type = 'YX' THEN null
        END AS invoice_reference

        <include refid="updateTrxInvoice-fragment"/>
    </update>

    <update id="updateTransactionInvoiceYK">

        <include refid="insertTrxInvoice-fragment"/>
        <include refid="selectTrxInvoice-fragment"/>
        CASE
        WHEN stage.doc_type = 'YK' THEN 'INVOICE'
        END AS line_of_business,
        CASE
        WHEN stage.doc_type = 'YK' THEN stage.document_no
        END AS invoice_no,
        CASE
        WHEN stage.doc_type = 'YK' THEN null
        END AS invoice_reference

        <include refid="updateTrxInvoice-fragment"/>
    </update>

    <update id="updateTransactionInvoiceY1">

        <include refid="insertTrxInvoice-fragment"/>
        <include refid="selectTrxInvoice-fragment"/>
        CASE
        WHEN stage.doc_type = 'Y1' THEN 'PAYMENT'
        END AS line_of_business,
        CASE
        when stage.doc_type = 'Y1' then null
        end as invoice_no,
        CASE
        WHEN stage.doc_type = 'Y1' THEN stage.reference
        END AS invoice_reference

        <include refid="updateTrxInvoice-fragment"/>
    </update>

    <update id="updateTransactionInvoiceYE">

        <include refid="insertTrxInvoice-fragment"/>
        <include refid="selectTrxInvoice-fragment"/>
        CASE
        WHEN stage.doc_type = 'YE' THEN 'DEBIT'
        END AS line_of_business,
        CASE
        WHEN stage.doc_type = 'YE' THEN stage.document_no
        END AS invoice_no,
        CASE
        WHEN stage.doc_type = 'YE' THEN null
        END AS invoice_reference

        <include refid="updateTrxInvoice-fragment"/>
    </update>

    <update id="updateTransactionInvoiceYM">

        <include refid="insertTrxInvoice-fragment"/>
        <include refid="selectTrxInvoice-fragment"/>
        CASE
        WHEN stage.doc_type = 'YM' THEN 'CREDIT'
        END AS line_of_business,
        CASE
        when stage.doc_type = 'YM' then null
        end as invoice_no,
        CASE
        WHEN stage.doc_type = 'YM' AND (stage.bill_doc = null) THEN stage.assignment
        WHEN stage.doc_type = 'YM' AND (stage.bill_doc != null) THEN stage.bill_doc
        END AS invoice_reference

        <include refid="updateTrxInvoice-fragment"/>
    </update>

    <update id="updateTransactionInvoiceYF">

        <include refid="insertTrxInvoice-fragment"/>
        <include refid="selectTrxInvoice-fragment"/>

        CASE
        WHEN stage.doc_type = 'YF' THEN 'CREDIT'
        END AS line_of_business,
        CASE
        when stage.doc_type = 'YF' then null
        end as invoice_no,
        CASE
        WHEN stage.doc_type = 'YF' THEN stage.reference
        END AS invoice_reference

        <include refid="updateTrxInvoice-fragment"/>
    </update>

    <update id="updateTransactionInvoiceZZ">

        <include refid="insertTrxInvoice-fragment"/>
        <include refid="selectTrxInvoice-fragment"/>
        case
        when stage.doc_type = 'ZZ' and (stage.transaction_type_id = 1 and stage.reference = 'RI') then 'LPC'
        when stage.doc_type = 'ZZ' and (stage.transaction_type_id = 1 and stage.reference != 'RI') then 'INVOICE'
        when stage.doc_type = 'ZZ' then 'PAYMENT'
        end as line_of_business,

        case
        when stage.doc_type = 'ZZ' and (stage.transaction_type_id = 1 and stage.reference = 'RI') then stage.document_no
        when stage.doc_type = 'ZZ' and (stage.transaction_type_id = 1 and stage.reference != 'RI') then stage.bill_doc
        end as invoice_no,

        case
        when stage.doc_type = 'ZZ' and (stage.transaction_type_id != 1 and stage.reference != 'RI') then
        stage.clearing_doc
        end as invoice_reference

        <include refid="updateTrxInvoice-fragment"/>
    </update>

    <update id="updateTransactionInvoiceOthers">

        <include refid="insertTrxInvoice-fragment"/>
        <include refid="selectTrxInvoice-fragment"/>

        CASE
        WHEN stage.doc_type not in ('AB','RG','YY','GI','RI','RM','RV','RY','YC','YD','YH','YI','YJ','YL','YN', 'YO',
        'YP','YQ','YR','YS','YT','YU','YV','YW','YX','YK','Y1','YE','YM','YF','ZZ') THEN 'OTHERS'
        END AS line_of_business,
        CASE
        WHEN stage.doc_type not in ('AB','RG','YY','GI','RI','RM','RV','RY','YC','YD','YH','YI','YJ','YL','YN', 'YO',
        'YP','YQ','YR','YS','YT','YU','YV','YW','YX','YK','Y1','YE','YM','YF','ZZ') THEN null
        END AS invoice_no,
        CASE
        WHEN stage.doc_type not in ('AB','RG','YY','GI','RI','RM','RV','RY','YC','YD','YH','YI','YJ','YL','YN', 'YO',
        'YP','YQ','YR','YS','YT','YU','YV','YW','YX','YK','Y1','YE','YM','YF','ZZ') THEN stage.reference
        END AS invoice_reference

        <include refid="updateTrxInvoice-fragment"/>
    </update>
</mapper>